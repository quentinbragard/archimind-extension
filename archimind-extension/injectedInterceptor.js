(function(){const h=window.fetch,d={USER_INFO:"/backend-api/me",CONVERSATIONS_LIST:"/backend-api/conversations",CHAT_COMPLETION:"/backend-api/conversation",SPECIFIC_CONVERSATION:/\/backend-api\/conversation\/([a-f0-9-]+)$/};function a(n){if(!n)return null;const e=n.startsWith("http")?new URL(n).pathname:n.split("?")[0];return d.SPECIFIC_CONVERSATION.test(e)?"specificConversation":e===d.USER_INFO?"userInfo":e.startsWith(d.CONVERSATIONS_LIST)?"conversationList":e.startsWith(d.CHAT_COMPLETION)?"chatCompletion":null}function l(n,e){document.dispatchEvent(new CustomEvent("archimind-network-intercept",{detail:{type:n,data:e,timestamp:Date.now()}}))}function _(n,e,t){var m,s,c,o,p,i,u;if(e||(e={messageId:null,conversationId:null,model:null,content:"",isComplete:!1,currentThinkingStep:null,createTime:null,parentMessageId:null}),t||(t=[]),n.type==="message_stream_complete")return e.isComplete=!0,e.conversationId=n.conversation_id||e.conversationId,{assistantData:e,thinkingSteps:t};if(n.o==="add"&&((m=n.v)!=null&&m.message)){e.messageId=n.v.message.id,e.conversationId=n.v.conversation_id,e.model=((s=n.v.message.metadata)==null?void 0:s.model_slug)||null,n.v.message.create_time&&(e.createTime=n.v.message.create_time),(c=n.v.message.metadata)!=null&&c.parent_id&&(e.parentMessageId=n.v.message.metadata.parent_id);const r=(o=n.v.message.author)==null?void 0:o.role,f={id:n.v.message.id,role:r,content:"",createTime:n.v.message.create_time,parentMessageId:(p=n.v.message.metadata)==null?void 0:p.parent_id,initialText:((i=n.v.message.metadata)==null?void 0:i.initial_text)||"",finishedText:((u=n.v.message.metadata)==null?void 0:u.finished_text)||""};return t.push(f),e.currentThinkingStep=t.length-1,r==="assistant"&&(e.content=""),{assistantData:e,thinkingSteps:t}}if(n.o==="append"&&n.p==="/message/content/parts/0"&&n.v)return e.currentThinkingStep!==null&&e.currentThinkingStep<t.length&&(t[e.currentThinkingStep].content+=n.v,t[e.currentThinkingStep].role==="assistant"&&(e.content+=n.v)),{assistantData:e,thinkingSteps:t};if(typeof n.v=="string"&&!n.o)return e.currentThinkingStep!==null&&e.currentThinkingStep<t.length&&(t[e.currentThinkingStep].content+=n.v,t[e.currentThinkingStep].role==="assistant"&&(e.content+=n.v)),{assistantData:e,thinkingSteps:t};if(n.o==="patch"&&Array.isArray(n.v)){for(const r of n.v)r.p==="/message/status"&&r.v,r.p==="/message/metadata/finished_text"&&e.currentThinkingStep!==null&&(t[e.currentThinkingStep].finishedText=r.v),r.p==="/message/content/parts/0"&&r.o==="append"&&r.v&&e.currentThinkingStep!==null&&e.currentThinkingStep<t.length&&(t[e.currentThinkingStep].content+=r.v,t[e.currentThinkingStep].role==="assistant"&&(e.content+=r.v));return{assistantData:e,thinkingSteps:t}}return{assistantData:e,thinkingSteps:t}}async function C(n,e){console.log("PROCESSING STREAMING RESPONSE");const m=n.clone().body.getReader(),s=new TextDecoder;let c="",o={messageId:null,conversationId:null,model:null,content:"",isComplete:!1,createTime:null,parentMessageId:null},p=[];try{for(;;){const{done:i,value:u}=await m.read();if(i)break;c+=s.decode(u,{stream:!0});let r;for(;(r=c.indexOf(`

`))!==-1;){const f=c.substring(0,r+2);c=c.substring(r+2);const T=f.match(/^event: ([^\n]+)/),g=f.match(/data: (.+)$/m);if(!g)continue;const S=T?T[1]:"unknown";if(g[1]==="[DONE]"){console.log("Received [DONE] message, finalizing response"),o.messageId&&o.content.length>0&&(o.isComplete=!0,l("assistantResponse",o));continue}try{const v=JSON.parse(g[1]);if(v.type==="message_stream_complete"){o.messageId&&(o.isComplete=!0,console.log("Stream processing complete"),l("assistantResponse",o));continue}const I=_(v,o,p);o=I.assistantData,p=I.thinkingSteps,o.messageId&&o.content.length>0&&o.content.length%500===0&&l("assistantResponse",{...o,isComplete:!1})}catch(v){console.error("Error parsing data:",v,"Raw data:",g[1])}}}o.messageId&&o.content.length>0&&!o.isComplete&&(console.log("Stream ended without completion signal, sending final data"),o.isComplete=!0,l("assistantResponse",o))}catch(i){console.error("Error processing stream:",i),o.messageId&&o.content.length>0&&(console.log("Salvaging partial response after error"),o.isComplete=!0,l("assistantResponse",o))}}window.fetch=async function(n,e){var o,p,i,u;const t=typeof n=="string"?n:n instanceof URL?n.toString():n.url,m=a(t);if(!m)return h.apply(this,arguments);let s=null;if(e&&e.body)try{const r=typeof e.body=="string"?e.body:new TextDecoder().decode(e.body);r.trim().startsWith("{")&&(s=JSON.parse(r),s.parent_message_provider_id&&console.log("ðŸ”— Parent message ID detected:",s.parent_message_provider_id))}catch{}const c=await h.apply(this,arguments);if(!c.ok)return c;try{const r=((o=c.headers.get("content-type"))==null?void 0:o.includes("text/event-stream"))||!1;if(m==="chatCompletion")l("chatCompletion",{requestBody:s}),r&&((u=(i=(p=s==null?void 0:s.messages)==null?void 0:p[0])==null?void 0:i.author)==null?void 0:u.role)==="user"&&C(c,s);else if(!r){const f=await c.clone().json().catch(()=>null);f&&l(m,{url:t,requestBody:s,responseBody:f,method:(e==null?void 0:e.method)||"GET"})}}catch(r){console.error("Error in fetch interceptor:",r)}return c},l("injectionComplete",{status:"success"})})();
